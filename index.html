<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>Dragon's World</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d0a1a;color:#fff;font-family:'Segoe UI',Arial,sans-serif;overflow:hidden}
canvas{display:block}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.78);padding:10px 16px;border-radius:10px;font-size:14px;line-height:1.8;pointer-events:none;z-index:5}
#cdbar{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.78);padding:8px 24px;border-radius:20px;font-size:13px;pointer-events:none;z-index:5;white-space:nowrap}
#ov{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;z-index:20}
#ov h2{font-size:3em}#ov p{font-size:1.1em;color:#ccc;text-align:center;max-width:420px}
#ov button{padding:14px 40px;font-size:1.05em;border:none;border-radius:10px;cursor:pointer;font-weight:bold}
</style>
</head><body>
<canvas id="c"></canvas>
<div id="hud"></div>
<div id="cdbar"></div>
<div id="ov"><h2 id="oT"></h2><p id="oM"></p><button id="oBtn"></button></div>

<script>
// Level 1‚Äì6 dragon roster
const LV=[
  {em:'üåë',c:'#aa44cc',n:'Shadowmend',el:'Dark',  ab:'Freeze all enemies for 5s'},
  {em:'üåø',c:'#44bb44',n:'Verdenwing',el:'Forest',ab:'Invisible to enemies for 4s'},
  {em:'üåä',c:'#00bbaa',n:'Tidesong',  el:'Ocean', ab:'2√ó speed for 3s'},
  {em:'‚ö°',c:'#ffcc00',n:'Stormtalon',el:'Sky',   ab:'Instant forward dash 300px'},
  {em:'üî•',c:'#ff4400',n:'Emberclaw', el:'Fire',  ab:'Fire ring ‚Äî knocks enemies back 50px'},
  {em:'‚ùÑÔ∏è',c:'#4499ff',n:'Frostfang', el:'Ice',   ab:'Freeze nearby enemies for 2s'},
];

// 4 map zones (each 1000√ó1000 quadrant of 2000√ó2000 map)
const ZN=[
  {n:'Volcanic Wastes', x:0,    y:0,    bg:'#1a0300',ac:'#ff4400',ec:'#ff3300',ow:54,oh:26},
  {n:'Glacial Peaks',   x:1000, y:0,    bg:'#000d1e',ac:'#88ccff',ec:'#66aaee',ow:14,oh:74},
  {n:'Sunken Reef',     x:0,    y:1000, bg:'#001212',ac:'#00bbaa',ec:'#00cc99',ow:30,oh:30},
  {n:'Ancient Canopy',  x:1000, y:1000, bg:'#001300',ac:'#44aa44',ec:'#339933',ow:22,oh:54},
];
const OBC=['#bb2200','#77aacc','#006655','#1e3e1e'];
const ESP=[210,78,145,125], ESZ=[20,46,20,20];

const cv=document.getElementById('c'), ctx=cv.getContext('2d');
const MAP=2000;
let P,ENS,OBS,EGS,GE,PTS,IW,PJ,RINGS,gt,lts,st,lv,dead,won,keys={},fx=1,fy=0,moved;

const hyp=(ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
const hits=(a,b)=>a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
const rnd=(lo,hi)=>lo+Math.random()*(hi-lo);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

function startLevel(level){
  lv=level; dead=won=false; gt=0; st=0; lts=null; moved=false;
  // Player starts at exact map center
  P={x:986,y:986,w:28,h:28,cd:0,spT:0,ivT:0};
  ENS=[]; OBS=[]; EGS=[]; IW=[]; PJ=[]; PTS=[]; RINGS=[]; GE=null;
  ZN.forEach((z,zi)=>{
    for(let i=0;i<12;i++){
      let ox,oy;
      do{ ox=rnd(z.x+40,z.x+960); oy=rnd(z.y+40,z.y+960); }
      while(hyp(ox,oy,1000,1000)<280);
      OBS.push({x:ox,y:oy,w:z.ow,h:z.oh,c:OBC[zi]});
    }
    EGS.push({x:rnd(z.x+200,z.x+800),y:rnd(z.y+200,z.y+800),r:12,done:false,t:0});
    se(zi); se(zi);
  });
  document.getElementById('ov').style.display='none';
  cv.width=innerWidth; cv.height=innerHeight;
  requestAnimationFrame(tick);
}

function se(zi){
  const z=ZN[zi], sm=1+st*.2;
  ENS.push({
    x:rnd(z.x+80,z.x+920), y:rnd(z.y+80,z.y+920),
    w:ESZ[zi]*sm, h:ESZ[zi]*sm, spd:ESP[zi]*sm,
    c:z.ec, zi, ft:0, wt:rnd(0,6.28), tcd:rnd(0,2)
  });
}

function mv(o,dx,dy){
  let nx=clamp(o.x+dx,0,MAP-o.w);
  if(!OBS.some(b=>hits({x:nx,y:o.y,w:o.w,h:o.h},b))) o.x=nx;
  let ny=clamp(o.y+dy,0,MAP-o.h);
  if(!OBS.some(b=>hits({x:o.x,y:ny,w:o.w,h:o.h},b))) o.y=ny;
}

function mvE(e,dx,dy){
  const z=ZN[e.zi], bl=OBS.concat(IW);
  let nx=clamp(e.x+dx,z.x,z.x+1000-e.w);
  if(!bl.some(b=>hits({x:nx,y:e.y,w:e.w,h:e.h},b))) e.x=nx;
  let ny=clamp(e.y+dy,z.y,z.y+1000-e.h);
  if(!bl.some(b=>hits({x:e.x,y:ny,w:e.w,h:e.h},b))) e.y=ny;
}

function abl(){
  if(P.cd>0) return;
  P.cd=10;
  const px=P.x+14, py=P.y+14;
  if(lv===1){
    // Shadowmend: freeze all enemies 5s
    ENS.forEach(e=>e.ft=5);
  } else if(lv===2){
    // Verdenwing: invisible 4s
    P.ivT=4;
  } else if(lv===3){
    // Tidesong: 2√ó speed 3s
    P.spT=3;
  } else if(lv===4){
    // Stormtalon: dash 300px forward
    P.x=clamp(P.x+fx*300,0,MAP-28);
    P.y=clamp(P.y+fy*300,0,MAP-28);
  } else if(lv===5){
    // Emberclaw: expanding fire ring, knocks all enemies within 180px back 50px
    RINGS.push({x:px,y:py,r:10,maxR:180,life:1,ice:false});
    ENS.forEach(e=>{
      const ex=e.x+e.w/2, ey=e.y+e.h/2, d=hyp(px,py,ex,ey);
      if(d<180){
        const ang=Math.atan2(ey-py,ex-px), z=ZN[e.zi];
        e.x=clamp(e.x+Math.cos(ang)*50, z.x, z.x+1000-e.w);
        e.y=clamp(e.y+Math.sin(ang)*50, z.y, z.y+1000-e.h);
        for(let j=0;j<5;j++) PTS.push({x:ex,y:ey,vx:rnd(-200,200),vy:rnd(-200,200),life:.5,c:'#ff6600'});
      }
    });
  } else if(lv===6){
    // Frostfang: freeze nearby enemies (within 300px) for 2s
    RINGS.push({x:px,y:py,r:10,maxR:300,life:.8,ice:true});
    ENS.forEach(e=>{
      if(hyp(px,py,e.x+e.w/2,e.y+e.h/2)<300) e.ft=2;
    });
  }
}

function tick(ts){
  if(dead||won) return;
  const dt=Math.min((ts-(lts||ts))/1000,.05); lts=ts;
  if(moved) gt+=dt;

  // Scale enemies every 30s of active play time
  if(moved && Math.floor(gt/30)>st){
    st++;
    ENS.forEach(e=>{e.w*=1.2; e.h*=1.2; e.spd*=1.2;});
    ZN.forEach((_,zi)=>se(zi));
  }

  // Player input
  let dx=0, dy=0;
  if(keys.ArrowLeft ||keys.a||keys.A) dx--;
  if(keys.ArrowRight||keys.d||keys.D) dx++;
  if(keys.ArrowUp   ||keys.w||keys.W) dy--;
  if(keys.ArrowDown ||keys.s||keys.S) dy++;
  if(dx||dy){
    const m=hyp(0,0,dx,dy); fx=dx/m; fy=dy/m;
    if(!moved) moved=true;
    mv(P, fx*180*(P.spT>0?2:1)*dt, fy*180*(P.spT>0?2:1)*dt);
  }
  if(P.cd>0)  P.cd-=dt;
  if(P.spT>0) P.spT-=dt;
  if(P.ivT>0) P.ivT-=dt;

  IW=IW.filter(w=>{w.life-=dt;return w.life>0;});
  // Rings expand then fade
  RINGS=RINGS.filter(r=>{r.life-=dt; r.r+=(r.maxR-10)/0.8*dt; return r.life>0;});

  PJ=PJ.filter(p=>{
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
    if(p.life<=0||p.x<0||p.x>MAP||p.y<0||p.y>MAP) return false;
    const i=OBS.findIndex(o=>hyp(p.x,p.y,o.x+o.w/2,o.y+o.h/2)<p.r+Math.max(o.w,o.h)/2);
    if(i>=0){
      const o=OBS[i];
      for(let j=0;j<8;j++) PTS.push({x:o.x+o.w/2,y:o.y+o.h/2,vx:rnd(-240,240),vy:rnd(-240,240),life:.7,c:'#ff6600'});
      OBS.splice(i,1); return false;
    }
    return true;
  });

  // Enemies frozen until player first moves
  if(moved) ENS.forEach(e=>{
    if(e.ft>0){e.ft-=dt;return;}
    if(P.ivT>0) return;
    const px=P.x+14, py=P.y+14;
    const ang=Math.atan2(py-(e.y+e.h/2), px-(e.x+e.w/2));
    if(e.zi===0||e.zi===1){
      // Magmawyrm (fast) & Frostwyrm (slow/huge): direct chasers
      mvE(e,Math.cos(ang)*e.spd*dt, Math.sin(ang)*e.spd*dt);
    } else if(e.zi===2){
      // Tidewyrm: sinusoidal wave path
      e.wt+=dt*2;
      const wa=ang+Math.sin(e.wt)*1.6;
      mvE(e,Math.cos(wa)*e.spd*dt, Math.sin(wa)*e.spd*dt);
    } else {
      // Thornwyrm: short teleport bursts toward player
      e.tcd-=dt;
      if(e.tcd<=0){
        e.tcd=1.5+rnd(0,1.5);
        const td=80+rnd(0,90), z=ZN[3];
        e.x=clamp(e.x+Math.cos(ang)*td, z.x, z.x+1000-e.w);
        e.y=clamp(e.y+Math.sin(ang)*td, z.y, z.y+1000-e.h);
      }
    }
    if(hits(e,P)) endG(false);
  });

  // Collect zone eggs
  EGS.forEach(e=>{
    if(e.done) return;
    e.t+=dt*3;
    if(hits({x:e.x-e.r,y:e.y-e.r,w:e.r*2,h:e.r*2},P)){
      e.done=true;
      for(let j=0;j<12;j++) PTS.push({x:e.x,y:e.y,vx:rnd(-320,320),vy:rnd(-320,320),life:.9,c:'#ffff00'});
    }
  });

  if(!GE && EGS.every(e=>e.done))
    GE={x:rnd(250,1750),y:rnd(250,1750),r:16,t:0};
  if(GE){
    GE.t+=dt*4;
    if(hits({x:GE.x-GE.r,y:GE.y-GE.r,w:GE.r*2,h:GE.r*2},P)) endG(true);
  }

  PTS=PTS.filter(p=>{p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt; return p.life>0;});
  draw();
  requestAnimationFrame(tick);
}

function endG(w){
  won=w; dead=!w;
  const d=LV[lv-1];
  const oT=document.getElementById('oT'), oM=document.getElementById('oM'), oBtn=document.getElementById('oBtn');
  if(w && lv<6){
    oT.style.color='#ffd700'; oT.textContent=`Level ${lv} Complete! üèÜ`;
    oM.textContent=`You collected all eggs as ${d.n}!\nNext up: Level ${lv+1} ‚Äî ${LV[lv].n} ${LV[lv].em}`;
    oBtn.textContent='Next Level ‚Üí'; oBtn.style.background='#ffd700'; oBtn.style.color='#111';
    oBtn.onclick=()=>startLevel(lv+1);
  } else if(w){
    oT.style.color='#ffd700'; oT.textContent='Dragon Master! üåü';
    oM.textContent='You completed all 6 levels and mastered every dragon. Legendary!';
    oBtn.textContent='Play Again'; oBtn.style.background='#ffd700'; oBtn.style.color='#111';
    oBtn.onclick=()=>startLevel(1);
  } else {
    oT.style.color='#ff4444'; oT.textContent='Game Over üíÄ';
    oM.textContent=`A dragon enemy caught you!\nReturning to Level 1 ‚Äî Shadowmend üåë`;
    oBtn.textContent='Try Again'; oBtn.style.background='#ff4444'; oBtn.style.color='#fff';
    oBtn.onclick=()=>startLevel(1);
  }
  document.getElementById('ov').style.display='flex';
}

function draw(){
  const W=cv.width, H=cv.height, d=LV[lv-1];
  const camx=clamp(P.x+14-W/2, 0, MAP-W);
  const camy=clamp(P.y+14-H/2, 0, MAP-H);
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(-camx,-camy);

  // Zone backgrounds
  ZN.forEach(z=>{
    ctx.fillStyle=z.bg; ctx.fillRect(z.x,z.y,1000,1000);
    ctx.strokeStyle=z.ac+'40'; ctx.lineWidth=4; ctx.strokeRect(z.x,z.y,1000,1000);
    ctx.fillStyle=z.ac+'50'; ctx.font='bold 14px Segoe UI';
    ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(z.n,z.x+14,z.y+14);
  });

  // Subtle grid
  ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1;
  for(let i=0;i<=MAP;i+=200){
    ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,MAP);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(MAP,i);ctx.stroke();
  }

  // Obstacles
  OBS.forEach(o=>{
    ctx.fillStyle=o.c; ctx.fillRect(o.x,o.y,o.w,o.h);
    ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=1; ctx.strokeRect(o.x,o.y,o.w,o.h);
  });

  // Ice walls (Frostfang lv1 ability ‚Äî unused in lv6 but kept for future)
  IW.forEach(w=>{
    ctx.fillStyle='rgba(153,204,255,0.82)'; ctx.fillRect(w.x,w.y,w.w,w.h);
    ctx.strokeStyle='#cce8ff'; ctx.lineWidth=2; ctx.strokeRect(w.x,w.y,w.w,w.h);
  });

  // Ability rings (fire ring lv5 / frost ring lv6)
  RINGS.forEach(r=>{
    const alpha=Math.max(0,r.life)*(r.ice?.7:.6);
    ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,6.28);
    ctx.strokeStyle=r.ice?`rgba(140,210,255,${alpha})`:`rgba(255,100,0,${alpha})`;
    ctx.lineWidth=r.ice?10:12; ctx.stroke();
  });

  // Zone eggs
  EGS.forEach(e=>{
    if(e.done) return;
    ctx.beginPath(); ctx.arc(e.x,e.y,Math.sin(e.t)*5+e.r+4,0,6.28);
    ctx.fillStyle='rgba(255,255,0,0.12)'; ctx.fill();
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,6.28);
    ctx.fillStyle='#ffffcc'; ctx.fill(); ctx.strokeStyle='#ffff00'; ctx.lineWidth=2; ctx.stroke();
    ctx.font='13px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ü•ö',e.x,e.y);
  });

  // Golden egg
  if(GE){
    ctx.beginPath(); ctx.arc(GE.x,GE.y,Math.sin(GE.t)*10+GE.r+6,0,6.28);
    ctx.fillStyle='rgba(255,215,0,0.25)'; ctx.fill();
    ctx.beginPath(); ctx.arc(GE.x,GE.y,GE.r,0,6.28);
    ctx.fillStyle='#ffd700'; ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.stroke();
    ctx.font='22px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ü•ö',GE.x,GE.y);
  }

  // Enemies
  ENS.forEach(e=>{
    ctx.save();
    const frozen=e.ft>0||!moved;
    if(frozen) ctx.globalAlpha=.5;
    ctx.fillStyle=frozen?'#aaddff':e.c;
    ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.font=`${clamp(e.w*.75,10,26)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('üê≤',e.x+e.w/2,e.y+e.h/2);
    ctx.restore();
  });

  // Fire projectiles (unused at lv1-4,6 but available)
  PJ.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,6.28); ctx.fillStyle='#ff6600'; ctx.fill();
    ctx.strokeStyle='rgba(255,170,0,0.5)'; ctx.lineWidth=5; ctx.stroke();
  });

  // Particles
  ctx.save();
  PTS.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.beginPath(); ctx.arc(p.x,p.y,3,0,6.28); ctx.fillStyle=p.c; ctx.fill();
  });
  ctx.restore();

  // Player
  ctx.save();
  if(P.ivT>0) ctx.globalAlpha=.3;
  ctx.font='30px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(d.em, P.x+14, P.y+14);
  ctx.restore();

  ctx.restore(); // end camera

  // HUD
  const col=EGS.filter(e=>e.done).length;
  const mins=Math.floor(gt/60), secs=(gt%60|0).toString().padStart(2,'0');
  document.getElementById('hud').innerHTML=
    `<b style="color:${d.c}">${d.em} ${d.n}</b> <span style="color:#666;font-size:.85em">Lv ${lv}/6</span><br>`+
    `‚è± ${mins}:${secs} &nbsp;|&nbsp; ü•ö ${col}/4`+
    (GE?'<br><b style="color:#ffd700">‚ú® Find the Golden Egg!</b>':'')+
    (!moved?'<br><span style="color:#aaa;font-size:.9em">Move to begin!</span>':'')+
    (P.ivT>0?`<br><span style="color:#88ff88">üëÅ Invisible ${P.ivT.toFixed(1)}s</span>`:'')+
    (P.spT>0?`<br><span style="color:#88ccff">‚ö° Speed ${P.spT.toFixed(1)}s</span>`:'');

  const cd=document.getElementById('cdbar');
  cd.style.color=P.cd>0?'#888':'#ffd700';
  cd.textContent=P.cd>0?`[SPACE] Recharging ${P.cd.toFixed(1)}s‚Ä¶`:`[SPACE] ${d.ab}`;
}

document.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key===' '){e.preventDefault(); if(P&&!dead&&!won&&moved) abl();}
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup',e=>{keys[e.key]=false;});
window.addEventListener('resize',()=>{cv.width=innerWidth; cv.height=innerHeight;});

startLevel(1);
</script>
</body>
</html>
