<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>Dragon's World</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d0a1a;color:#fff;font-family:'Segoe UI',Arial,sans-serif;overflow:hidden}
canvas{display:block}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.78);padding:10px 16px;border-radius:10px;font-size:14px;line-height:1.8;pointer-events:none;z-index:5}
#cdbar{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.78);padding:8px 24px;border-radius:20px;font-size:13px;pointer-events:none;z-index:5;white-space:nowrap}
#ov{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;z-index:20}
#ov h2{font-size:3em}#ov p{font-size:1.1em;color:#ccc;text-align:center;max-width:420px}
#ov button{padding:14px 40px;font-size:1.05em;border:none;border-radius:10px;cursor:pointer;font-weight:bold}
</style>
</head><body>
<canvas id="c"></canvas>
<div id="hud"></div>
<div id="cdbar"></div>
<div id="ov"><h2 id="oT"></h2><p id="oM"></p><button id="oBtn"></button></div>

<script>
const LV=[
  {em:'üåë',c:'#aa44cc',n:'Shadowmend',el:'Dark',  ab:'Freeze all enemies for 5s'},
  {em:'üåø',c:'#44bb44',n:'Verdenwing',el:'Forest',ab:'Invisible to enemies for 4s'},
  {em:'üåä',c:'#00bbaa',n:'Tidesong',  el:'Ocean', ab:'2√ó speed for 3s'},
  {em:'‚ö°',c:'#ffcc00',n:'Stormtalon',el:'Sky',   ab:'Instant forward dash 300px'},
  {em:'üî•',c:'#ff4400',n:'Emberclaw', el:'Fire',  ab:'Fire ring ‚Äî knocks enemies back 50px'},
  {em:'‚ùÑÔ∏è',c:'#4499ff',n:'Frostfang', el:'Ice',   ab:'Freeze nearby enemies for 2s'},
];
const ZN=[
  {n:'Volcanic Wastes', x:0,    y:0,    bg:'#1a0300',ac:'#ff4400',ec:'#ff3300',ow:54,oh:26},
  {n:'Glacial Peaks',   x:1000, y:0,    bg:'#000d1e',ac:'#88ccff',ec:'#66aaee',ow:14,oh:74},
  {n:'Sunken Reef',     x:0,    y:1000, bg:'#001212',ac:'#00bbaa',ec:'#00cc99',ow:30,oh:30},
  {n:'Ancient Canopy',  x:1000, y:1000, bg:'#001300',ac:'#44aa44',ec:'#339933',ow:22,oh:54},
];
const OBC=['#bb2200','#77aacc','#006655','#1e3e1e'];
const ESP=[210,78,145,125], ESZ=[20,46,20,20];

const cv=document.getElementById('c'), ctx=cv.getContext('2d');
const MAP=2000;
let P,ENS,OBS,EGS,GE,PTS,IW,PJ,RINGS,BLTS,ZS,gt,lts,st,lv,dead,won,keys={},fx=1,fy=0,moved;

const hyp=(ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
const hits=(a,b)=>a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
const rnd=(lo,hi)=>lo+Math.random()*(hi-lo);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

function startLevel(level){
  lv=level; dead=won=false; gt=0; st=0; lts=null; moved=false;
  P={x:986,y:986,w:28,h:28,cd:0,spT:0,ivT:0};
  ENS=[]; OBS=[]; EGS=[]; IW=[]; PJ=[]; PTS=[]; RINGS=[]; BLTS=[]; GE=null;
  // Per-zone state: timers and escalating variables
  ZS=[
    {t5:5, t10:10, obsT:5},                      // Volcanic: speed/dup/slide timers
    {shot:5, grow:5, brk:2.5, resp:[]},           // Glacial: shoot/grow/break/respawn queue
    {t5:5, t10:10, amp:1.6},                      // Sunken Reef: amplitude/multiply timers
    {t10:10, t5:5, td:80, addT:5, addN:0},        // Canopy: multiply/jump range/obstacle-add timers
  ];
  ZN.forEach((z,zi)=>{
    for(let i=0;i<12;i++){
      let ox,oy;
      do{ ox=rnd(z.x+40,z.x+960); oy=rnd(z.y+40,z.y+960); }
      while(hyp(ox,oy,1000,1000)<280);
      const o={x:ox,y:oy,w:z.ow,h:z.oh,c:OBC[zi],zi};
      // Sunken Reef obstacles bounce; give them a random velocity
      if(zi===2){ o.vx=(Math.random()<.5?-1:1)*rnd(55,110); o.vy=(Math.random()<.5?-1:1)*rnd(55,110); }
      OBS.push(o);
    }
    EGS.push({x:rnd(z.x+200,z.x+800),y:rnd(z.y+200,z.y+800),r:12,done:false,t:0});
  });
  // Zone-specific initial spawns
  const vz=ZN[0];
  // Volcanic: exactly 1 Magmawyrm at HALF speed
  ENS.push({x:rnd(vz.x+80,vz.x+920),y:rnd(vz.y+80,vz.y+920),w:ESZ[0],h:ESZ[0],spd:ESP[0]*.5,c:vz.ec,zi:0,ft:0,wt:0,tcd:0});
  se(1);        // Glacial: 1 Frostwyrm
  se(2); se(2); // Sunken Reef: 2 Tidewyrms
  se(3); se(3); // Ancient Canopy: 2 Thornwyrms
  document.getElementById('ov').style.display='none';
  cv.width=innerWidth; cv.height=innerHeight;
  requestAnimationFrame(tick);
}

function se(zi){
  const z=ZN[zi], sm=1+st*.2;
  ENS.push({
    x:rnd(z.x+80,z.x+920), y:rnd(z.y+80,z.y+920),
    w:ESZ[zi]*sm, h:ESZ[zi]*sm, spd:ESP[zi]*sm,
    c:z.ec, zi, ft:0, wt:rnd(0,6.28), tcd:rnd(0,2)
  });
}

function mv(o,dx,dy){
  let nx=clamp(o.x+dx,0,MAP-o.w);
  if(!OBS.some(b=>hits({x:nx,y:o.y,w:o.w,h:o.h},b))) o.x=nx;
  let ny=clamp(o.y+dy,0,MAP-o.h);
  if(!OBS.some(b=>hits({x:o.x,y:ny,w:o.w,h:o.h},b))) o.y=ny;
}

function mvE(e,dx,dy){
  const z=ZN[e.zi], bl=OBS.concat(IW);
  let nx=clamp(e.x+dx,z.x,z.x+1000-e.w);
  if(!bl.some(b=>hits({x:nx,y:e.y,w:e.w,h:e.h},b))) e.x=nx;
  let ny=clamp(e.y+dy,z.y,z.y+1000-e.h);
  if(!bl.some(b=>hits({x:e.x,y:ny,w:e.w,h:e.h},b))) e.y=ny;
}

function abl(){
  if(P.cd>0) return;
  P.cd=10;
  const px=P.x+14, py=P.y+14;
  if(lv===1){ ENS.forEach(e=>e.ft=5); }
  else if(lv===2){ P.ivT=4; }
  else if(lv===3){ P.spT=3; }
  else if(lv===4){ P.x=clamp(P.x+fx*300,0,MAP-28); P.y=clamp(P.y+fy*300,0,MAP-28); }
  else if(lv===5){
    RINGS.push({x:px,y:py,r:10,maxR:180,life:1,ice:false});
    ENS.forEach(e=>{
      const ex=e.x+e.w/2, ey=e.y+e.h/2, d=hyp(px,py,ex,ey);
      if(d<180){
        const ang=Math.atan2(ey-py,ex-px), z=ZN[e.zi];
        e.x=clamp(e.x+Math.cos(ang)*50, z.x, z.x+1000-e.w);
        e.y=clamp(e.y+Math.sin(ang)*50, z.y, z.y+1000-e.h);
        for(let j=0;j<5;j++) PTS.push({x:ex,y:ey,vx:rnd(-200,200),vy:rnd(-200,200),life:.5,c:'#ff6600'});
      }
    });
  } else {
    RINGS.push({x:px,y:py,r:10,maxR:300,life:.8,ice:true});
    ENS.forEach(e=>{if(hyp(px,py,e.x+e.w/2,e.y+e.h/2)<300) e.ft=2;});
  }
}

// ‚îÄ‚îÄ Zone-specific escalating behaviors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateZones(dt){
  const px=P.x+14, py=P.y+14;

  // ‚îÄ‚îÄ Volcanic Wastes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ZS[0].t5-=dt; ZS[0].t10-=dt; ZS[0].obsT-=dt;
  // Speed boost every 5s
  if(ZS[0].t5<=0){ ZS[0].t5=5; ENS.filter(e=>e.zi===0).forEach(e=>e.spd*=1.2); }
  // Duplicate every 10s (max 4)
  if(ZS[0].t10<=0){
    ZS[0].t10=10;
    const vs=ENS.filter(e=>e.zi===0);
    if(vs.length>0&&vs.length<4){
      const s=vs[0], z=ZN[0];
      ENS.push({...s, x:clamp(s.x+rnd(-50,50),z.x+10,z.x+990-s.w), y:clamp(s.y+rnd(-50,50),z.y+10,z.y+990-s.h), ft:0});
    }
  }
  // All volcanic obstacles slide to a new random position every 5s then stop abruptly
  if(ZS[0].obsT<=0){
    ZS[0].obsT=5;
    const z=ZN[0];
    OBS.filter(o=>o.zi===0).forEach(o=>{ o.tx=rnd(z.x+30,z.x+970); o.ty=rnd(z.y+30,z.y+970); });
  }
  OBS.filter(o=>o.zi===0&&o.tx!=null).forEach(o=>{
    const ddx=o.tx-o.x, ddy=o.ty-o.y, dd=Math.hypot(ddx,ddy);
    if(dd<5){ o.x=o.tx; o.y=o.ty; delete o.tx; delete o.ty; }
    else{ o.x+=ddx/dd*620*dt; o.y+=ddy/dd*620*dt; }
  });

  // ‚îÄ‚îÄ Glacial Peaks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ZS[1].shot-=dt; ZS[1].grow-=dt; ZS[1].brk-=dt;
  // Fire bullet toward player every 5s
  if(ZS[1].shot<=0){
    ZS[1].shot=5;
    const fw=ENS.find(e=>e.zi===1);
    if(fw){
      const ang=Math.atan2(py-(fw.y+fw.h/2), px-(fw.x+fw.w/2));
      BLTS.push({x:fw.x+fw.w/2, y:fw.y+fw.h/2, vx:Math.cos(ang)*360, vy:Math.sin(ang)*360, r:9});
    }
  }
  // Frostwyrm grows 20% bigger every 5s
  if(ZS[1].grow<=0){ ZS[1].grow=5; ENS.filter(e=>e.zi===1).forEach(e=>{e.w*=1.2; e.h*=1.2;}); }
  // Breaks/destroys one random obstacle every 2.5s; it respawns after 8s
  if(ZS[1].brk<=0){
    ZS[1].brk=2.5;
    const go=OBS.filter(o=>o.zi===1);
    if(go.length){
      const target=go[Math.floor(Math.random()*go.length)];
      for(let j=0;j<5;j++) PTS.push({x:target.x+target.w/2,y:target.y+target.h/2,vx:rnd(-160,160),vy:rnd(-160,160),life:.7,c:'#aaddff'});
      OBS.splice(OBS.indexOf(target),1);
      ZS[1].resp.push({t:8});
    }
  }
  ZS[1].resp=ZS[1].resp.filter(r=>{
    r.t-=dt;
    if(r.t<=0){ const z=ZN[1]; OBS.push({x:rnd(z.x+40,z.x+960),y:rnd(z.y+40,z.y+960),w:z.ow,h:z.oh,c:OBC[1],zi:1}); return false; }
    return true;
  });

  // ‚îÄ‚îÄ Sunken Reef ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ZS[2].t5-=dt; ZS[2].t10-=dt;
  if(ZS[2].t5<=0){ ZS[2].t5=5; ZS[2].amp+=0.45; } // wave grows more erratic
  if(ZS[2].t10<=0){ ZS[2].t10=10; se(2); }
  // Bounce reef obstacles around zone; knock back player and enemies on hit
  OBS.filter(o=>o.zi===2&&o.vx!=null).forEach(o=>{
    const z=ZN[2];
    o.x+=o.vx*dt; o.y+=o.vy*dt;
    if(o.x<=z.x||o.x+o.w>=z.x+1000){ o.vx=-o.vx; o.x=clamp(o.x,z.x,z.x+1000-o.w); }
    if(o.y<=z.y||o.y+o.h>=z.y+1000){ o.vy=-o.vy; o.y=clamp(o.y,z.y,z.y+1000-o.h); }
    const kb=(obj,cx,cy)=>{
      const ang=Math.atan2(obj.y+obj.h/2-cy, obj.x+obj.w/2-cx);
      obj.x=clamp(obj.x+Math.cos(ang)*40,0,MAP-obj.w);
      obj.y=clamp(obj.y+Math.sin(ang)*40,0,MAP-obj.h);
    };
    if(hits(o,P)) kb(P, o.x+o.w/2, o.y+o.h/2);
    ENS.filter(e=>e.zi===2&&hits(o,e)).forEach(e=>{
      const z2=ZN[2], cx=o.x+o.w/2, cy=o.y+o.h/2, ang=Math.atan2(e.y+e.h/2-cy,e.x+e.w/2-cx);
      e.x=clamp(e.x+Math.cos(ang)*40,z2.x,z2.x+1000-e.w);
      e.y=clamp(e.y+Math.sin(ang)*40,z2.y,z2.y+1000-e.h);
    });
  });

  // ‚îÄ‚îÄ Ancient Canopy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ZS[3].t10-=dt; ZS[3].t5-=dt; ZS[3].addT-=dt;
  if(ZS[3].t10<=0){ ZS[3].t10=10; se(3); }                  // multiply
  if(ZS[3].t5<=0){ ZS[3].t5=5; ZS[3].td+=50; }             // teleport range grows
  if(ZS[3].addT<=0){                                         // escalating obstacle adds (1,2,3‚Ä¶)
    ZS[3].addT=5; ZS[3].addN++;
    const z=ZN[3];
    for(let i=0;i<ZS[3].addN;i++)
      OBS.push({x:rnd(z.x+30,z.x+970),y:rnd(z.y+30,z.y+970),w:z.ow,h:z.oh,c:OBC[3],zi:3});
  }
}

function tick(ts){
  if(dead||won) return;
  const dt=Math.min((ts-(lts||ts))/1000,.05); lts=ts;
  if(moved) gt+=dt;

  // Global 30s scaling: size+speed for all enemies, new spawn for non-Volcanic zones
  if(moved && Math.floor(gt/30)>st){
    st++;
    ENS.forEach(e=>{e.w*=1.2; e.h*=1.2; e.spd*=1.2;});
    ZN.forEach((_,zi)=>{ if(zi!==0) se(zi); }); // Volcanic has its own spawn system
  }

  // Player input
  let dx=0, dy=0;
  if(keys.ArrowLeft ||keys.a||keys.A) dx--;
  if(keys.ArrowRight||keys.d||keys.D) dx++;
  if(keys.ArrowUp   ||keys.w||keys.W) dy--;
  if(keys.ArrowDown ||keys.s||keys.S) dy++;
  if(dx||dy){
    const m=hyp(0,0,dx,dy); fx=dx/m; fy=dy/m;
    if(!moved) moved=true;
    mv(P, fx*180*(P.spT>0?2:1)*dt, fy*180*(P.spT>0?2:1)*dt);
  }
  if(P.cd>0)  P.cd-=dt;
  if(P.spT>0) P.spT-=dt;
  if(P.ivT>0) P.ivT-=dt;

  IW=IW.filter(w=>{w.life-=dt;return w.life>0;});
  RINGS=RINGS.filter(r=>{r.life-=dt; r.r+=(r.maxR-10)/0.8*dt; return r.life>0;});

  PJ=PJ.filter(p=>{
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
    if(p.life<=0||p.x<0||p.x>MAP||p.y<0||p.y>MAP) return false;
    const i=OBS.findIndex(o=>hyp(p.x,p.y,o.x+o.w/2,o.y+o.h/2)<p.r+Math.max(o.w,o.h)/2);
    if(i>=0){
      const o=OBS[i];
      for(let j=0;j<8;j++) PTS.push({x:o.x+o.w/2,y:o.y+o.h/2,vx:rnd(-240,240),vy:rnd(-240,240),life:.7,c:'#ff6600'});
      OBS.splice(i,1); return false;
    }
    return true;
  });

  if(moved) updateZones(dt);

  // Glacial bullets ‚Äî kill player on contact, expire outside Glacial zone
  BLTS=BLTS.filter(b=>{
    b.x+=b.vx*dt; b.y+=b.vy*dt;
    if(b.x<1000||b.x>2000||b.y<0||b.y>1000) return false;
    if(hits({x:b.x-b.r,y:b.y-b.r,w:b.r*2,h:b.r*2},P)){ endG(false); return false; }
    return true;
  });

  // Enemies frozen until player first moves
  if(moved) ENS.forEach(e=>{
    if(e.ft>0){e.ft-=dt;return;}
    if(P.ivT>0) return;
    const epx=P.x+14, epy=P.y+14;
    const ang=Math.atan2(epy-(e.y+e.h/2), epx-(e.x+e.w/2));
    if(e.zi===0||e.zi===1){
      mvE(e,Math.cos(ang)*e.spd*dt, Math.sin(ang)*e.spd*dt);
    } else if(e.zi===2){
      // Tidewyrm: sinusoidal wave; amplitude escalates via ZS[2].amp
      e.wt+=dt*2;
      const wa=ang+Math.sin(e.wt)*ZS[2].amp;
      mvE(e,Math.cos(wa)*e.spd*dt, Math.sin(wa)*e.spd*dt);
    } else {
      // Thornwyrm: teleport distance escalates via ZS[3].td
      e.tcd-=dt;
      if(e.tcd<=0){
        e.tcd=1.5+rnd(0,1.5);
        const td=ZS[3].td+rnd(0,40), z=ZN[3];
        e.x=clamp(e.x+Math.cos(ang)*td, z.x, z.x+1000-e.w);
        e.y=clamp(e.y+Math.sin(ang)*td, z.y, z.y+1000-e.h);
      }
    }
    if(hits(e,P)) endG(false);
  });

  EGS.forEach(e=>{
    if(e.done) return;
    e.t+=dt*3;
    if(hits({x:e.x-e.r,y:e.y-e.r,w:e.r*2,h:e.r*2},P)){
      e.done=true;
      for(let j=0;j<12;j++) PTS.push({x:e.x,y:e.y,vx:rnd(-320,320),vy:rnd(-320,320),life:.9,c:'#ffff00'});
    }
  });

  if(!GE && EGS.every(e=>e.done))
    GE={x:rnd(250,1750),y:rnd(250,1750),r:16,t:0};
  if(GE){
    GE.t+=dt*4;
    if(hits({x:GE.x-GE.r,y:GE.y-GE.r,w:GE.r*2,h:GE.r*2},P)) endG(true);
  }

  PTS=PTS.filter(p=>{p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt; return p.life>0;});
  draw();
  requestAnimationFrame(tick);
}

function endG(w){
  won=w; dead=!w;
  const d=LV[lv-1];
  const oT=document.getElementById('oT'), oM=document.getElementById('oM'), oBtn=document.getElementById('oBtn');
  if(w && lv<6){
    oT.style.color='#ffd700'; oT.textContent=`Level ${lv} Complete! üèÜ`;
    oM.textContent=`You collected all eggs as ${d.n}!\nNext up: Level ${lv+1} ‚Äî ${LV[lv].n} ${LV[lv].em}`;
    oBtn.textContent='Next Level ‚Üí'; oBtn.style.background='#ffd700'; oBtn.style.color='#111';
    oBtn.onclick=()=>startLevel(lv+1);
  } else if(w){
    oT.style.color='#ffd700'; oT.textContent='Dragon Master! üåü';
    oM.textContent='You completed all 6 levels and mastered every dragon. Legendary!';
    oBtn.textContent='Play Again'; oBtn.style.background='#ffd700'; oBtn.style.color='#111';
    oBtn.onclick=()=>startLevel(1);
  } else {
    oT.style.color='#ff4444'; oT.textContent='Game Over üíÄ';
    oM.textContent=`A dragon enemy caught you!\nReturning to Level 1 ‚Äî Shadowmend üåë`;
    oBtn.textContent='Try Again'; oBtn.style.background='#ff4444'; oBtn.style.color='#fff';
    oBtn.onclick=()=>startLevel(1);
  }
  document.getElementById('ov').style.display='flex';
}

function draw(){
  const W=cv.width, H=cv.height, d=LV[lv-1];
  const camx=clamp(P.x+14-W/2, 0, MAP-W);
  const camy=clamp(P.y+14-H/2, 0, MAP-H);
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(-camx,-camy);

  ZN.forEach(z=>{
    ctx.fillStyle=z.bg; ctx.fillRect(z.x,z.y,1000,1000);
    ctx.strokeStyle=z.ac+'40'; ctx.lineWidth=4; ctx.strokeRect(z.x,z.y,1000,1000);
    ctx.fillStyle=z.ac+'50'; ctx.font='bold 14px Segoe UI';
    ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(z.n,z.x+14,z.y+14);
  });

  ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1;
  for(let i=0;i<=MAP;i+=200){
    ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,MAP);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(MAP,i);ctx.stroke();
  }

  // Obstacles ‚Äî volcanic ones glow orange while sliding; reef ones glow teal while moving
  OBS.forEach(o=>{
    ctx.fillStyle=o.c; ctx.fillRect(o.x,o.y,o.w,o.h);
    const sliding=o.zi===0&&o.tx!=null, bouncing=o.zi===2&&o.vx!=null;
    ctx.strokeStyle=sliding?'#ff8800':bouncing?'#00ddbb':'rgba(255,255,255,0.12)';
    ctx.lineWidth=sliding||bouncing?2:1;
    ctx.strokeRect(o.x,o.y,o.w,o.h);
  });

  IW.forEach(w=>{
    ctx.fillStyle='rgba(153,204,255,0.82)'; ctx.fillRect(w.x,w.y,w.w,w.h);
    ctx.strokeStyle='#cce8ff'; ctx.lineWidth=2; ctx.strokeRect(w.x,w.y,w.w,w.h);
  });

  RINGS.forEach(r=>{
    const alpha=Math.max(0,r.life)*(r.ice?.7:.6);
    ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,6.28);
    ctx.strokeStyle=r.ice?`rgba(140,210,255,${alpha})`:`rgba(255,100,0,${alpha})`;
    ctx.lineWidth=r.ice?10:12; ctx.stroke();
  });

  // Glacial ice bullets
  BLTS.forEach(b=>{
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,6.28);
    ctx.fillStyle='#ccecff'; ctx.fill();
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=2; ctx.stroke();
    // trailing glow
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r+5,0,6.28);
    ctx.strokeStyle='rgba(136,204,255,0.4)'; ctx.lineWidth=4; ctx.stroke();
  });

  EGS.forEach(e=>{
    if(e.done) return;
    ctx.beginPath(); ctx.arc(e.x,e.y,Math.sin(e.t)*5+e.r+4,0,6.28);
    ctx.fillStyle='rgba(255,255,0,0.12)'; ctx.fill();
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,6.28);
    ctx.fillStyle='#ffffcc'; ctx.fill(); ctx.strokeStyle='#ffff00'; ctx.lineWidth=2; ctx.stroke();
    ctx.font='13px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ü•ö',e.x,e.y);
  });

  if(GE){
    ctx.beginPath(); ctx.arc(GE.x,GE.y,Math.sin(GE.t)*10+GE.r+6,0,6.28);
    ctx.fillStyle='rgba(255,215,0,0.25)'; ctx.fill();
    ctx.beginPath(); ctx.arc(GE.x,GE.y,GE.r,0,6.28);
    ctx.fillStyle='#ffd700'; ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.stroke();
    ctx.font='22px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ü•ö',GE.x,GE.y);
  }

  ENS.forEach(e=>{
    ctx.save();
    const frozen=e.ft>0||!moved;
    if(frozen) ctx.globalAlpha=.5;
    ctx.fillStyle=frozen?'#aaddff':e.c;
    ctx.fillRect(e.x,e.y,e.w,e.h);
    ctx.font=`${clamp(e.w*.75,10,26)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('üê≤',e.x+e.w/2,e.y+e.h/2);
    ctx.restore();
  });

  PJ.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,6.28); ctx.fillStyle='#ff6600'; ctx.fill();
    ctx.strokeStyle='rgba(255,170,0,0.5)'; ctx.lineWidth=5; ctx.stroke();
  });

  ctx.save();
  PTS.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.beginPath(); ctx.arc(p.x,p.y,3,0,6.28); ctx.fillStyle=p.c; ctx.fill();
  });
  ctx.restore();

  ctx.save();
  if(P.ivT>0) ctx.globalAlpha=.3;
  ctx.font='30px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(d.em, P.x+14, P.y+14);
  ctx.restore();

  ctx.restore();

  const col=EGS.filter(e=>e.done).length;
  const mins=Math.floor(gt/60), secs=(gt%60|0).toString().padStart(2,'0');
  document.getElementById('hud').innerHTML=
    `<b style="color:${d.c}">${d.em} ${d.n}</b> <span style="color:#666;font-size:.85em">Lv ${lv}/6</span><br>`+
    `‚è± ${mins}:${secs} &nbsp;|&nbsp; ü•ö ${col}/4`+
    (GE?'<br><b style="color:#ffd700">‚ú® Find the Golden Egg!</b>':'')+
    (!moved?'<br><span style="color:#aaa;font-size:.9em">Move to begin!</span>':'')+
    (P.ivT>0?`<br><span style="color:#88ff88">üëÅ Invisible ${P.ivT.toFixed(1)}s</span>`:'')+
    (P.spT>0?`<br><span style="color:#88ccff">‚ö° Speed ${P.spT.toFixed(1)}s</span>`:'');

  const cd=document.getElementById('cdbar');
  cd.style.color=P.cd>0?'#888':'#ffd700';
  cd.textContent=P.cd>0?`[SPACE] Recharging ${P.cd.toFixed(1)}s‚Ä¶`:`[SPACE] ${d.ab}`;
}

document.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key===' '){e.preventDefault(); if(P&&!dead&&!won&&moved) abl();}
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup',e=>{keys[e.key]=false;});
window.addEventListener('resize',()=>{cv.width=innerWidth; cv.height=innerHeight;});

startLevel(1);
</script>
</body>
</html>
